stages:
  - test
  - build

test:
  stage: test
  image: node:22-slim
  script:
    - npm ci
    - npm test
  rules:
    - when: always

build-windows:
  stage: build
  image: rust:latest
  variables:
    CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  before_script:
    # Install system dependencies for Tauri CLI (Linux build tools + WebKit for compilation)
    - apt-get update && apt-get install -y
        nodejs npm
        libwebkit2gtk-4.1-dev
        libgtk-3-dev
        libayatana-appindicator3-dev
        librsvg2-dev
        wget
    # Install cargo-xwin for cross-compiling to Windows
    - cargo install cargo-xwin
    - rustup target add x86_64-pc-windows-msvc
    # Install frontend dependencies
    - npm ci
  script:
    - npx tauri build --target x86_64-pc-windows-msvc --no-bundle
  artifacts:
    paths:
      - src-tauri/target/x86_64-pc-windows-msvc/release/*.exe
    expire_in: 30 days
  cache:
    key: rust-cargo-cache
    paths:
      - .cargo/registry
      - .cargo/git
      - src-tauri/target
  rules:
    - when: always
