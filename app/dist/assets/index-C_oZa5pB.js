async function s(u,e={},n){return window.__TAURI_INTERNALS__.invoke(u,e,n)}const c="Request cancelled";async function q(u,e){const n=e?.signal;if(n?.aborted)throw new Error(c);const b=e?.maxRedirections,g=e?.connectTimeout,E=e?.proxy,m=e?.danger;e&&(delete e.maxRedirections,delete e.connectTimeout,delete e.proxy,delete e.danger);const a=e?.headers?e.headers instanceof Headers?e.headers:new Headers(e.headers):new Headers,o=new Request(u,e),i=await o.arrayBuffer(),R=i.byteLength!==0?Array.from(new Uint8Array(i)):null;for(const[r,t]of o.headers)a.get(r)||a.set(r,t);const _=(a instanceof Headers?Array.from(a.entries()):Array.isArray(a)?a:Object.entries(a)).map(([r,t])=>[r,typeof t=="string"?t:t.toString()]);if(n?.aborted)throw new Error(c);const f=await s("plugin:http|fetch",{clientConfig:{method:o.method,url:o.url,headers:_,data:R,maxRedirections:b,connectTimeout:g,proxy:E,danger:m}}),l=()=>s("plugin:http|fetch_cancel",{rid:f});if(n?.aborted)throw l(),new Error(c);n?.addEventListener("abort",()=>{l()});const{status:y,statusText:A,url:v,headers:x,rid:w}=await s("plugin:http|fetch_send",{rid:f}),p=()=>s("plugin:http|fetch_cancel_body",{rid:w}),L=async r=>{let t;try{t=await s("plugin:http|fetch_read_body",{rid:w})}catch(U){r.error(U),p();return}const d=new Uint8Array(t),S=d[d.byteLength-1],T=d.slice(0,d.byteLength-1);if(S===1){r.close();return}r.enqueue(T)},H=[101,103,204,205,304].includes(y)?null:new ReadableStream({start:r=>{n?.addEventListener("abort",()=>{r.error(c),p()})},pull:r=>L(r),cancel:()=>{p()}}),h=new Response(H,{status:y,statusText:A});return Object.defineProperty(h,"url",{value:v}),Object.defineProperty(h,"headers",{value:new Headers(x)}),h}export{q as fetch};
